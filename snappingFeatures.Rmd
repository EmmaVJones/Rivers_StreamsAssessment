---
title: "Snapping Features"
author: "Emma Jones"
date: "December 7, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# R 3.5.1
library(tidyverse)
library(sf)
library(leaflet)
library(mapview)

```

## Purpose
This script walks users through snapping DEQ StationID's (with coordinate information) to the Water Quality Standards spatial layer. The points are then plotted with the snapped WQS segment and features that did not retrieve stream segments or to more than one segment are highlighted for further review. Then, we explore pulling out information from the WQS layer and additional spatial layers to populate a Stations table similar to Mike's MONITOR table.


### Snapping Sampling Points to WQS Layer

First we are just going to start with the New River basin WQS layer to keep workflow fast.

Bring in most of 2018 IR window sample data and snapping functions. Filter the statewide sample sites to just New basin. Make a data frame of unique sample sites that need WQS information.

```{r data retrieval}

# functions
source('snapFunctions.R')

# data
newWQS <- st_read('GIS/WQS2018_BRRO_albers.shp')
conventionals <- read_csv('data/conventionals08152018EVJ.csv')
newSites_sf <- filter(conventionals, Basin == "New River Basin") %>%
  distinct(FDT_STA_ID, .keep_all = TRUE) %>%
  select(FDT_STA_ID:FDT_SPG_CODE,STA_LV2_CODE:STA_CBP_NAME) %>% # drop sample data
  st_as_sf(coords = c("Longitude", "Latitude"), 
           remove = F, # don't remove these lat/lon cols from df
           crs = 4269) %>% # add projection, needs to be geographic for now bc entering lat/lng, 
  st_transform( st_crs(WQS)) # now change crs to Albers to make snapping work

```

Start snapping sites to WQS. Use a 50 meter max buffer and buffer in 10 meter increments. 

```{r snap}

snapList <- snap_Points_to_Feature_List(newSites_sf,'FDT_STA_ID',newWQS, seq(10,50,by=10))

#saveRDS(snapList,'data/snapList_new.RDS')
```

Investigate the results.

```{r investigate}
# sites that didnt find a segment within 50 m
fail <- snapList[['tbl_output']]
nrow(fail)
success <- snapList[['sf_output']]
length(unique(success$`Point Unique Identifier`))

```

So about half worked with 50m buffer.

Try those that didn't work with 80 m buffer.

```{r try with 80 m buffer}

```

